<!doctype html>
<html lang="en">
<meta charset="utf-8">
<title>Serial Connect Demo</title>
<style>
  body { font-family: system-ui, sans-serif; margin: 20px; }
  #openPort { position: fixed; top: 10px; right: 10px; width: 32px; height: 32px;
    border: 1px solid #555; border-radius: 50%; text-align: center; line-height: 32px;
    cursor: pointer; background: #f5f5f5; }
  #console { display: none; margin-top: 60px; padding: 0.5em; border: 1px solid #ccc;
    min-height: 6em; white-space: pre-wrap; width: 320px; overflow-y: auto; }
</style>

<div id="openPort">âœ–</div>
<div id="console"></div>

<script>
let port, reader;
const logEl = document.getElementById('console');
const openBtn = document.getElementById('openPort');

function log(msg){
  logEl.textContent += msg + "\n";
  logEl.scrollTop = logEl.scrollHeight;
}

openBtn.addEventListener('click', async () => {
  if (!("serial" in navigator)) {
    alert("Your browser does not support Web Serial API (use Chrome/Edge/Opera).");
    return;
  }
  try {
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 115200 });
    logEl.style.display = 'block';
    log("Port opened.");

    const decoder = new TextDecoder();
    reader = port.readable.getReader();
    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      if (value) log("RX: " + decoder.decode(value));
    }
  } catch (err) {
    log("Open error: " + err);
  }
});

window.addEventListener('beforeunload', async () => {
  try {
    if (reader) {
      await reader.cancel();
      reader.releaseLock();
    }
    if (port) await port.close();
  } catch (err) {
    // ignore
  }
});
</script>
</html>
