<!doctype html>
<html lang="en">
<meta charset="utf-8">
<title>Serial Connect Demo</title>
<style>
  body { font-family: system-ui, sans-serif; margin: 20px; }
  #log { margin-top: 1em; padding: 0.5em; border: 1px solid #ccc; min-height: 6em; white-space: pre-wrap; }
  button { margin-right: 0.5em; }
</style>

<h1>Serial Connect Demo</h1>
<p>
  <button id="btnConnect">Connect</button>
  <button id="btnDisconnect" disabled>Disconnect</button>
</p>
<div id="log"></div>

<script>
let port, reader;

const logEl = document.getElementById('log');
function log(msg){ logEl.textContent += msg + "\n"; logEl.scrollTop = logEl.scrollHeight; }

document.getElementById('btnConnect').onclick = async () => {
  if (!("serial" in navigator)) {
    alert("Your browser does not support Web Serial API (use Chrome/Edge/Opera).");
    return;
  }
  try {
    // Ask the user to select a port
    port = await navigator.serial.requestPort();
    await port.open({ baudRate: 115200 }); // change to your baud rate
    log("Port opened.");

    // Read loop
    const decoder = new TextDecoder();
    reader = port.readable.getReader();
    (async () => {
      try {
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          if (value) log("RX: " + decoder.decode(value));
        }
      } catch (e) {
        log("Read error: " + e.message);
      }
    })();

    document.getElementById("btnConnect").disabled = true;
    document.getElementById("btnDisconnect").disabled = false;
  } catch (err) {
    log("Open error: " + err);
  }
};

document.getElementById('btnDisconnect').onclick = async () => {
  try {
    if (reader) {
      await reader.cancel();
      reader.releaseLock();
      reader = null;
    }
    if (port) {
      await port.close();
      port = null;
    }
    log("Port closed.");
  } catch (err) {
    log("Close error: " + err);
  }
  document.getElementById("btnConnect").disabled = false;
  document.getElementById("btnDisconnect").disabled = true;
};
</script>
</html>
